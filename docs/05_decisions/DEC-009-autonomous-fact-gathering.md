# DEC-009: AI による自律的な情報収集（Autonomous Fact Gathering）

## ステータス

**Accepted** - 2025-02-22

## 背景

### 現状の課題

neumann v1.0 は曖昧性を「検出・指摘」することに特化している。

**現在のフロー**:
1. ユーザー: 「全体的に厳しい状況です」と入力
2. neumann: 「定量性不足。具体的な数値やデータが必要です」と指摘
3. ユーザー: 自分でデータを探して入力（Salesforce を開く、Google Sheets を開く等）

**問題点**:
- 解消に必要な情報（前月比データ、案件フェーズ、KPI 実績値等）をユーザーが手入力する必要がある
- ユーザーは「どこにデータがあるか」を覚えていなければならない
- CEO が求める「Zero Latency（聞く前にファクトが揃っている）」には不十分

### ビジョン

AI が自律的にツール（CRM、データベース、スプレッドシート等）から情報を収集し、曖昧性解消に必要なファクトを推論・提案する。

**理想のフロー**:
1. ユーザー: 「全体的に厳しい状況です」と入力
2. neumann: 「定量性不足」を検出
3. neumann: Salesforce から過去3ヶ月の商談化率データを自動取得
4. neumann: 「前月比で商談化率が 25% → 10% に低下（-15pt）と記載することを推奨」と提案
5. ユーザー: ワンクリックで適用、または手動で編集

## 問題定義

**主要な論点**:
1. **何を収集すべきか** - どのツール・データソースから取得すべきか？
2. **どう収集するか** - 技術的実現性は？
3. **どう推論するか** - 推論精度をどう確保するか？
4. **どう提示するか** - UX 設計は？
5. **プライバシー・セキュリティ** - データアクセス権限は？
6. **いつ実装するか** - v1.1, v1.2, v2.0 のどこで実装するか？

詳細な論点分解と仮説検証プロセスは [docs/issues/002-autonomous-fact-gathering.md](../issues/002-autonomous-fact-gathering.md) を参照。

## 決定内容

### v1.1 で実装する機能（Autonomous Fact Gathering MVP）

**実装範囲**:

#### 1. Supabase 内部データ参照

- **概要**: neumann 内部で管理されている KPI 実績値を自動取得
- **機能**: 前月比の自動計算、トレンド分析
- **実装**: `src/domain/kpi/utils.ts` に関数追加
- **実装コスト**: 低（既存 DB の拡張）
- **価値**: 中（内部データのみだが確実に動作）

#### 2. Google Sheets 連携（実験版）

- **概要**: OAuth 2.0 で Google Sheets に接続し、KPI 実績値を取得
- **機能**: セル範囲を指定して値取得、前月比計算
- **実装**: `src/lib/integrations/google-sheets.ts` を新規作成
- **実装コスト**: 中（2〜3日）
- **価値**: 高（実際の業務データを活用）

**Google Sheets 連携の前提条件**:
- ユーザーが neumann 推奨フォーマットのテンプレートを使用
- 初期は手動マッピング UI でセル範囲を指定
- v1.2 で AI による自動マッピングに拡張

#### 3. 情報提示 UI（FactCard）

- **概要**: 取得したデータを Audit Panel 内にカード形式で表示
- **機能**: データソース名、取得値、前月比を表示。ユーザーが手動でコピー＆ペースト
- **実装**: `src/features/editor/components/FactCard.tsx` を新規作成
- **実装コスト**: 低（1日）
- **価値**: 中（ワンクリック適用は v1.2）

**UI イメージ**:
```
💡 AI が関連情報を取得しました:
┌─────────────────────────────┐
│ 📊 データソース: KPI実績値     │
│                              │
│ 商談化率:                     │
│ • 前月: 25%                   │
│ • 今月: 10%                   │
│ • 差分: -15pt                 │
│                              │
│ [値をコピー]                  │
└─────────────────────────────┘
```

#### 4. ルールベース推論エンジン

- **概要**: 曖昧性パターン → 情報源のマッピングルールを定義
- **ルール例**:
  - `定量性不足 + 商談化率言及 → Supabase KPI 実績値`
  - `定量性不足 + ARR 言及 → Google Sheets「売上管理」シート`
- **実装**: `src/domain/audit/inference-rules.ts` を新規作成
- **実装コスト**: 低（1日）
- **価値**: 高（精度 80% 想定）

### 実装しない範囲（v1.2 以降に延期）

| 機能 | 延期理由 | 実装タイミング |
|------|---------|--------------|
| **Salesforce 連携** | OAuth + 複雑な API 実装コスト高 | v1.2（4週間） |
| **AI 推論（Tool Calling）** | プロンプト設計の難易度高、誤推論リスク | v1.2〜v2.0 |
| **ワンクリック適用** | 誤推論時のリスク、学習効果の低下 | v1.2（推論精度向上後） |
| **Notion, Slack, GitHub 連携** | 優先度が低い | v2.0 |

### 段階的な実装戦略

| フェーズ | データソース | 推論方式 | UX | 実装期間 |
|---------|------------|---------|----|----|
| **v1.1** | Supabase, Google Sheets | ルールベース | 情報提示（コピー） | 2週間 |
| **v1.2** | + Salesforce | ハイブリッド（ルール + AI） | ワンクリック適用 | 4週間 |
| **v2.0** | + Notion, Slack, GitHub | AI 推論（Tool Calling） | 自動適用（オプション） | 8週間 |

## 検討した代替案

### 代替案A: v1.1 で Salesforce を優先

**内容**: Google Sheets ではなく Salesforce を最初に連携する

**メリット**:
- エンタープライズ向けの訴求力が高い
- データ構造が標準化されており、自動認識が容易

**デメリット**:
- OAuth + Salesforce API の実装コスト高（4週間）
- スタートアップ・中小企業では Salesforce 未導入のケースが多い

**判断**: v1.2 に延期。初期は Google Sheets で迅速に価値検証

### 代替案B: v1.1 でワンクリック適用を実装

**内容**: 情報提示だけでなく、ワンクリックで本文に自動反映

**メリット**:
- ユーザー負荷が最小化（コピー不要）
- Zero Latency により近づく

**デメリット**:
- 誤推論時に間違ったデータが本文に入る
- 学習効果が低下（ユーザーが考えなくなる）

**判断**: v1.2 に延期。v1.1 では推論精度を検証し、精度が十分に高ければ実装

### 代替案C: v1.1 で AI 推論（Tool Calling）を実装

**内容**: ルールベースではなく、Claude に動的にツールを選ばせる

**メリット**:
- 柔軟性が高い（未知のパターンにも対応）
- ルールのメンテナンス不要

**デメリット**:
- プロンプト設計の難易度が高い
- 誤推論のリスク（間違ったツールを呼ぶ可能性）
- LLM API コストが増加

**判断**: v1.2 に延期。v1.1 でルールベースの精度を検証してから判断

## 影響と結果

### プロダクトへの影響

**新規ファイル**:
```
src/
├── domain/
│   └── audit/
│       ├── inference-rules.ts      # NEW: ルールベース推論
│       └── fact-gathering.ts       # NEW: 情報収集ロジック
│
├── lib/
│   └── integrations/
│       └── google-sheets.ts        # NEW: Google Sheets API クライアント
│
└── features/
    └── editor/
        └── components/
            └── FactCard.tsx        # NEW: 取得データ表示カード
```

**既存ファイルへの影響**:
- `src/domain/kpi/utils.ts`: KPI 実績値取得関数を追加
- `src/features/editor/components/AuditPanel.tsx`: FactCard を表示するスロットを追加

### ユーザー体験への影響

**ポジティブな影響**:
- ユーザーが手入力する情報量が 30% 削減
- データ探索の手間が不要に（Google Sheets を開く必要がない）
- Zero Latency の第一歩を実現

**潜在的なリスク**:
- Google Sheets の構造が自由すぎて、自動認識が難しい
- 誤推論により間違ったデータを提示する可能性

**リスク緩和策**:
- v1.1 ではテンプレート提供（neumann 推奨フォーマット）
- 手動マッピング UI でセル範囲を指定可能
- データソース名を明示し、ユーザーが最終判断

### 技術的な影響

**外部依存の追加**:
- Google Cloud Console でプロジェクト作成が必要
- Google Sheets API の有効化
- OAuth 2.0 認証情報の管理

**セキュリティへの影響**:
- Google OAuth スコープ: `https://www.googleapis.com/auth/spreadsheets.readonly`（read-only）
- 取得データのキャッシュ: 24時間で削除
- ログ記録: PII のマスキング

**パフォーマンスへの影響**:
- Google Sheets API のレート制限: 100 requests/100 seconds/user
- Supabase クエリは既存 DB なので影響最小限

### ビジネスへの影響

**成功指標**:
- ユーザーが手入力する情報量が 30% 削減
- データ取得の成功率が 80% 以上
- 誤推論率が 10% 以下
- v1.1 リリースまでの実装期間が 2 週間以内

**競合優位性**:
- 類似プロダクト（Grammarly, Notion AI 等）は「文章の改善」のみ
- neumann は「データ取得 + 文脈に応じた提案」で差別化

## 関連ドキュメント

- [論点分析: AI による自律的な情報収集](../issues/002-autonomous-fact-gathering.md)
- [User Stories](../02_product/features/USER_STORIES.md) - US-015, US-016 で具体化
- [Architecture](../02_product/architecture.md) - システムアーキテクチャ
- [DEC-008: ユーザー負荷軽減](./DEC-008-user-load-reduction.md) - 関連する意思決定

## 次のアクション

### 即座に実行（v1.1 実装前の準備）

1. **User Stories の追加**
   - [ ] US-015: AI による情報収集（Manager 向け）
   - [ ] US-016: 情報ソース管理（CEO 向け）

2. **Google Cloud Console の準備**
   - [ ] プロジェクト作成
   - [ ] Sheets API の有効化
   - [ ] OAuth 2.0 認証情報の作成
   - [ ] リダイレクト URI の設定

3. **環境変数の設定**
   - [ ] `GOOGLE_CLIENT_ID`
   - [ ] `GOOGLE_CLIENT_SECRET`
   - [ ] `GOOGLE_REDIRECT_URI`

### v1.1 実装（2週間）

**Week 1: コア機能実装**
- [ ] Supabase 内部データ参照ロジック実装
- [ ] ルールベース推論エンジン実装
- [ ] FactCard コンポーネント実装

**Week 2: Google Sheets 連携**
- [ ] Google OAuth 実装
- [ ] Sheets API 統合
- [ ] エラーハンドリング・テスト
- [ ] ドキュメント更新（ユーザーガイド、テンプレート提供）

### v1.2 以降で検討

- [ ] Salesforce 連携
- [ ] AI 推論（Tool Calling）
- [ ] ワンクリック適用
- [ ] セル構造の自動認識（AI による推論）

## 未解決の論点

1. **Google Sheets の構造認識**
   - ユーザーが自由にフォーマットを定義できる Google Sheets で、どうやって「商談化率」のセルを特定するか？
   - → **v1.1 の対応**: テンプレート提供 + 手動マッピング UI
   - → **v1.2 の対応**: AI によるセル内容の推論

2. **推論の透明性**
   - AI が「なぜこのデータを取得したか」を説明すべきか？
   - → **v1.1 の対応**: データソース名のみ表示
   - → **v1.2 の対応**: 推論ロジックの説明を追加

3. **データ鮮度の管理**
   - キャッシュの有効期限をどう設定するか？
   - → **v1.1 の対応**: 24時間キャッシュ
   - → **v1.2 の対応**: ユーザー設定で調整可能に

4. **プライバシーポリシーの更新**
   - 外部ツールのデータを Claude API に送信することを明記すべきか？
   - → **v1.1 リリース前に必須**: 法務レビュー + ポリシー更新

## メタ情報

- **決定日**: 2025-02-22
- **決定者**: AI（Human 承認済み）
- **影響範囲**: Product Strategy, AI Integration, User Experience
- **レビュー予定**: v1.1 リリース後（成功指標の検証）
