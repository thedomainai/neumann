# Features

## Feature List

### Core Features (Must Have)

| ID | 機能名 | 説明 | 関連US | ステータス |
|----|--------|------|--------|-----------|
| F-001 | 曖昧性検出エンジン | レポートから5パターンの曖昧性を検出 | US-001, US-002 | ✅ 仕様承認済 |
| F-002 | 品質スコア算出 | 検出結果から品質スコア(0-100)を算出 | US-003 | Planning |
| F-003 | 改善提案生成 | 検出した曖昧性に対する具体的な改善案を生成 | US-004 | Planning |
| F-004 | レポートエディター | レポートの作成・編集画面 | US-005 | Planning |

### Important Features (Should Have)

| ID | 機能名 | 説明 | 関連US | ステータス |
|----|--------|------|--------|-----------|
| F-010 | リアルタイム検出 | 入力中にリアルタイムで曖昧性を検出 | US-006 | Backlog |
| F-011 | ダッシュボード | 全レポートのサマリ・品質推移表示 | US-007 | Backlog |
| F-012 | チーム管理 | チームメンバーの管理・権限設定 | US-008 | Backlog |
| F-030 | 自律的情報収集 | AIが外部ツールから関連データを自動取得し改善案を提示 | US-015 | Planning |
| F-031 | 情報ソース管理 | データソースの連携設定・アクセス制御 | US-016 | Planning |

### Nice to Have (Could Have)

| ID | 機能名 | 説明 | 関連US | ステータス |
|----|--------|------|--------|-----------|
| F-020 | Google Docs連携 | Google Docsからレポートをインポート | US-010 | Backlog |
| F-021 | Google Slides連携 | Google Slidesからレポートをインポート | US-010 | Backlog |
| F-022 | Notion連携 | Notionからレポートをインポート | US-010 | Backlog |
| F-023 | Slack通知 | 検出結果・リマインドをSlackに通知 | US-011 | Backlog |
| F-024 | KPIツリー表示 | 組織のKPIツリーを可視化 | US-012 | Backlog |

### Won't Have (This Phase)

| ID | 機能名 | 理由 |
|----|--------|------|
| F-X01 | 自動レポート生成 | MVP後に検討（Phase 3以降） |
| F-X02 | Google Chat監視 | リアルタイム介入は技術・UX検証後 |
| F-X03 | 多言語対応 | 日本語のみでMVP検証 |

---

## Feature Details

### F-001: 曖昧性検出エンジン

**概要:**
週次レポート・定例資料から曖昧性パターンを検出するコアエンジン。5つのパターンを検出し、それぞれに重要度（Critical/Warning/Info）を付与する。

**検出パターン:**

| コード | パターン名 | 検出難易度 |
|--------|-----------|-----------|
| FI | Fact/Interpretation Mixing（事実と解釈の混在） | Medium |
| LQ | Lack of Quantification（定量性不足） | Easy |
| UA | Unclear Action（行動不明確） | Easy |
| SA | Shallow Analysis（深掘り不足） | Hard |
| MC | Missing Coverage（網羅性不足） | Hard |

**ユーザーフロー:**
1. ユーザーがレポートを入力/インポート
2. システムが曖昧性検出を実行
3. 検出結果がサイドパネルに表示
4. ユーザーが各項目をクリックして詳細確認

**技術要件:**
- Vercel AI SDK + Claude API
- ストリーミングレスポンス（3秒以内に最初の結果表示）
- プロンプトは `lib/ai/prompts/audit.ts` で管理

**エッジケース:**
- 空のレポート: 「レポートが空です」とエラー表示
- 超長文レポート: 分割処理、進捗表示
- API障害: リトライ + エラーメッセージ

**依存関係:**
- 前提: なし（コア機能）
- 後続: F-002, F-003

**詳細仕様:** `02_product/features/audit-patterns.md` 参照

---

### F-002: 品質スコア算出

**概要:**
F-001の検出結果から品質スコア（0-100）を算出する。

**計算式:**
```
Quality Score = 100 - (Critical × 5 + Warning × 2 + Info × 1)
```

**スコア解釈:**

| スコア | 評価 | アクション |
|--------|------|-----------|
| 90-100 | Excellent | 承認可 |
| 70-89 | Good | 軽微な修正推奨 |
| 50-69 | Needs Improvement | 修正必須 |
| 0-49 | Poor | 再提出要求 |

**ユーザーフロー:**
1. F-001の検出完了後、自動でスコア算出
2. スコアとグレードをエディター上部に表示
3. スコアの内訳（パターン別）を展開可能

**UI/UX要件:**
- スコアは大きな数字で目立つ位置に表示
- 色分け: 緑(90+) / 黄(70-89) / オレンジ(50-69) / 赤(0-49)
- アニメーション: スコア算出時にカウントアップ

**技術要件:**
- クライアントサイドで計算（軽量）
- 検出結果のJSONからスコア算出

**依存関係:**
- 前提: F-001（検出結果）
- 後続: F-011（ダッシュボード）

---

### F-003: 改善提案生成

**概要:**
検出した曖昧性に対して、具体的な改善案（修正文）を生成する。

**ユーザーフロー:**
1. 検出項目をクリック
2. 「改善案を表示」ボタンをクリック
3. AIが改善案を生成・表示
4. 「適用」ボタンで本文に反映

**UI/UX要件:**
- 改善案は比較表示（Before / After）
- ワンクリックで適用
- 適用前にプレビュー可能

**技術要件:**
- Vercel AI SDK streamText
- 改善案生成用プロンプト
- 差分表示ライブラリ

**エッジケース:**
- 改善案が複数ある場合: 最大3つまで提示
- ユーザーが改善案を編集したい場合: 編集可能なテキストエリア

**依存関係:**
- 前提: F-001（検出結果）
- 後続: なし

---

### F-004: レポートエディター

**概要:**
レポートを作成・編集するメイン画面。曖昧性検出結果を右パネルに表示。

**画面構成:**
```
┌─────────────────────────────────────────────────────┐
│ [ヘッダー] レポートタイトル | 品質スコア | 保存    │
├────────────────────────────┬────────────────────────┤
│                            │                        │
│       エディター           │    検出結果パネル      │
│     （リッチテキスト）      │    - 問題一覧          │
│                            │    - 改善提案          │
│                            │    - スコア内訳        │
│                            │                        │
└────────────────────────────┴────────────────────────┘
```

**ユーザーフロー:**
1. レポート一覧から「新規作成」または既存レポートを選択
2. エディターでテキスト入力
3. 「検出実行」ボタンまたは自動検出
4. 右パネルで結果確認・改善
5. 「保存」で下書き保存、「提出」で確定

**UI/UX要件:**
- リッチテキストエディター（Markdown or WYSIWYG）
- 検出箇所のハイライト（クリックで詳細表示）
- オートセーブ（30秒間隔）
- キーボードショートカット

**技術要件:**
- TipTap or ProseMirror（エディター）
- shadcn/ui ResizablePanel（左右分割）
- Supabase Realtime（オートセーブ）

**エッジケース:**
- 複数タブで同時編集: 競合検知、マージUI
- ネットワーク切断: ローカル保存、再接続時同期

**依存関係:**
- 前提: F-001, F-002, F-003
- 後続: F-010（リアルタイム検出）

---

### F-030: 自律的情報収集（Autonomous Fact Gathering）

**概要:**
曖昧性検出時に、AIが外部ツール（Supabase, Google Sheets, Salesforce等）から関連データを自律的に取得し、改善案を提示する。

**ユーザーフロー:**
1. ユーザーが曖昧な表現を入力（例: 「全体的に厳しい状況です」）
2. F-001が曖昧性を検出（例: 定量性不足）
3. F-030が関連データを自律取得
   - ルールベース推論で情報源を特定
   - データソースから値を取得（前月比、KPI実績値等）
4. FactCardでデータと改善案を表示
5. ユーザーが確認して適用

**段階的実装:**

| フェーズ | データソース | 推論方式 | UX | 実装期間 |
|---------|------------|---------|----|----|
| **v1.1** | Supabase, Google Sheets | ルールベース | 情報提示（コピー） | 2週間 |
| **v1.2** | + Salesforce | ハイブリッド（ルール + AI） | ワンクリック適用 | 4週間 |
| **v2.0** | + Notion, Slack, GitHub | AI 推論（Tool Calling） | 自動適用（オプション） | 8週間 |

**v1.1 実装範囲:**
- Supabase 内部データ参照（KPI実績値、前月比計算）
- Google Sheets 連携（OAuth 2.0 + Sheets API）
- FactCard コンポーネント（カード形式で表示）
- ルールベース推論エンジン（曖昧性パターン → 情報源マッピング）

**UI イメージ（v1.1）:**
```
💡 AI が関連情報を取得しました:
┌─────────────────────────────┐
│ 📊 データソース: KPI実績値     │
│                              │
│ 商談化率:                     │
│ • 前月: 25%                   │
│ • 今月: 10%                   │
│ • 差分: -15pt                 │
│                              │
│ [値をコピー]                  │
└─────────────────────────────┘
```

**技術要件:**
- `src/domain/audit/inference-rules.ts`: ルールベース推論エンジン
- `src/domain/audit/fact-gathering.ts`: 情報収集ロジック
- `src/lib/integrations/google-sheets.ts`: Google Sheets API クライアント
- `src/features/editor/components/FactCard.tsx`: データ表示カード
- `src/domain/kpi/utils.ts`: KPI実績値取得関数

**セキュリティ要件:**
- OAuth スコープ: `https://www.googleapis.com/auth/spreadsheets.readonly`（read-only）
- データキャッシュ: 24時間で自動削除
- ログ記録: PII のマスキング
- RLS（Row Level Security）: Supabase 内部データのアクセス制御

**成功指標（v1.1）:**
- ユーザーが手入力する情報量が 30% 削減
- データ取得の成功率が 80% 以上
- 誤推論率が 10% 以下

**依存関係:**
- 前提: F-001（曖昧性検出）
- 後続: F-031（情報ソース管理）

**詳細仕様:**
- `docs/05_decisions/DEC-009-autonomous-fact-gathering.md`
- `docs/issues/002-autonomous-fact-gathering.md`

---

### F-031: 情報ソース管理（Data Source Management）

**概要:**
F-030が使用するデータソースの連携設定・アクセス制御を管理する。

**ユーザーフロー（CEO）:**
1. 設定画面で「データソース」タブを開く
2. 連携可能なツール一覧を表示（Google Sheets, Salesforce等）
3. 連携したいツールを選択してOAuth認証
4. セル範囲のマッピングを手動設定（v1.1）
5. 連携状態を確認・解除

**管理項目:**

| 項目 | 説明 | v1.1 | v1.2 |
|------|------|------|------|
| 連携ON/OFF | データソースごとに有効化・無効化 | ✅ | ✅ |
| OAuth認証 | Google Sheets, Salesforce等の認証 | ✅（Sheets） | ✅（+ SF） |
| セル範囲マッピング | Google Sheetsのセル範囲を手動指定 | ✅ | ✅（AI推論） |
| データ取得ログ | いつ何のデータを取得したか履歴表示 | - | ✅ |
| キャッシュ設定 | データキャッシュの有効期限設定 | - | ✅ |

**UI/UX要件（v1.1）:**
```
データソース設定
┌─────────────────────────────────────┐
│ Google Sheets                       │
│ [✅ 連携中] [連携を解除]              │
│                                     │
│ 連携済みシート:                      │
│ • KPI管理シート (セル範囲: A1:D10)   │
│ • 売上管理シート (セル範囲: B2:F20)  │
│                                     │
│ [新しいシートを追加]                  │
└─────────────────────────────────────┘

Salesforce
[連携する] （v1.2で実装予定）
```

**技術要件:**
- `src/features/settings/components/DataSourceSettings.tsx`: 設定UI
- `src/lib/integrations/oauth-manager.ts`: OAuth統合管理
- `src/domain/integrations/schema.ts`: データソース設定のスキーマ
- Supabase テーブル: `data_source_connections`

**セキュリティ原則:**
1. **最小権限**: 必要最小限のデータのみ取得
2. **透明性**: どのデータを取得したか明示
3. **ユーザー管理**: 連携の ON/OFF をユーザーが制御
4. **データ保持期間**: 取得データは 24 時間でキャッシュ削除

**依存関係:**
- 前提: F-030（自律的情報収集）
- 後続: なし

**詳細仕様:**
- `docs/05_decisions/DEC-009-autonomous-fact-gathering.md`

---

## Feature Flags

| フラグ名 | 機能 | 環境 | デフォルト |
|----------|------|------|-----------|
| `ENABLE_REALTIME_DETECTION` | リアルタイム検出 | Production | false |
| `ENABLE_AUTONOMOUS_FACT_GATHERING` | 自律的情報収集 | Staging | false |
| `ENABLE_GOOGLE_SHEETS_INTEGRATION` | Google Sheets連携 | Staging | false |
| `ENABLE_SALESFORCE_INTEGRATION` | Salesforce連携 | Staging | false |
| `ENABLE_GOOGLE_INTEGRATION` | Google連携（廃止予定） | Staging | false |
| `ENABLE_NOTION_INTEGRATION` | Notion連携 | Staging | false |

---

## Deprecated Features

| 機能名 | 廃止日 | 理由 | 移行先 |
|--------|--------|------|--------|
| - | - | - | - |

---

## Changelog

| 日付 | 変更内容 | 担当 |
|------|----------|------|
| 2026-01-23 | 初版作成（F-001〜F-024） | AI |
| 2026-02-23 | F-030（自律的情報収集）、F-031（情報ソース管理）追加。DEC-009の決定内容を反映 | AI |

---

*最終更新: 2026-02-23*
